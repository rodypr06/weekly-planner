<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Powered Weekly Task Planner - Liquid Glass</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="AI Powered Weekly Task Planner">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Weekly Planner">
    
    <!-- Existing Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item, .day-selector {
            transition: all 0.3s ease;
        }
        .task-item.removing {
            transform: scale(0.95);
            opacity: 0;
        }
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .custom-checkbox:checked {
            background-color: #818cf8; /* indigo-400 */
            border-color: #818cf8; /* indigo-400 */
        }
        .custom-checkbox:checked::before {
            content: '✓'; color: white; display: block; text-align: center; line-height: 1.25rem; font-size: 0.875rem;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .spinner {
            border-top-color: #818cf8; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .glass-pane {
            background: rgba(255, 255, 255, 0.05); -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .background-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .background-orb {
            position: absolute; border-radius: 50%; filter: blur(80px); will-change: transform;
        }
        #orb1 {
            background: radial-gradient(circle, #4f46e5, transparent 60%); width: 400px; height: 400px; top: 10%; left: 15%; animation: move-orb1 20s infinite alternate ease-in-out;
        }
        #orb2 {
            background: radial-gradient(circle, #a855f7, transparent 60%); width: 300px; height: 300px; top: 50%; left: 60%; animation: move-orb2 25s infinite alternate ease-in-out;
        }
        @keyframes move-orb1 { from { transform: translate(0, 0); } to { transform: translate(100px, 50px); } }
        @keyframes move-orb2 { from { transform: translate(0, 0); } to { transform: translate(-80px, -60px); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="background-container">
        <div id="orb1" class="background-orb"></div>
        <div id="orb2" class="background-orb"></div>
    </div>
    
    <div class="relative z-10 w-full max-w-4xl mx-auto my-8 glass-pane rounded-2xl shadow-2xl p-6 md:p-8">

        <!-- Header -->
        <div class="text-center mb-6">
            <svg class="w-20 h-20 mx-auto mb-4" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="logoGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#a855f7; stop-opacity:1" /><stop offset="100%" style="stop-color:#4f46e5; stop-opacity:1" /></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="50" cy="50" r="45" fill="none" stroke="url(#logoGradient)" stroke-width="4" style="filter:url(#glow)"/><path d="M30 50 L45 65 L70 40" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-100">Weekly Planner</h1>
            <p id="current-week-display" class="text-gray-400 mt-2 text-lg"></p>
        </div>

        <!-- Week Navigator -->
        <div class="flex items-center justify-between mb-6">
            <button id="prev-week-btn" class="p-2 rounded-full hover:bg-white/10 transition"><i class="fas fa-chevron-left"></i></button>
            <div id="week-days-container" class="flex-grow grid grid-cols-7 gap-2 mx-4">
                <!-- Day selectors will be generated here -->
            </div>
            <button id="next-week-btn" class="p-2 rounded-full hover:bg-white/10 transition"><i class="fas fa-chevron-right"></i></button>
        </div>


        <!-- Add Task Form -->
        <form id="add-task-form" class="bg-white/5 p-4 rounded-lg shadow-inner mb-6 border border-white/10">
            <div class="flex flex-col md:flex-row items-end gap-4">
                 <div class="flex-grow w-full">
                    <label class="text-sm font-medium text-gray-400 mb-2 block">New Task for <span id="new-task-date" class="font-bold"></span></label>
                    <input type="text" id="task-input" placeholder="What's your next task?" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" required>
                </div>
                 <div class="w-full md:w-auto">
                    <label class="text-sm font-medium text-gray-400 mb-2 block">Time <span class="opacity-75">(optional)</span></label>
                    <input type="time" id="time-input" class="w-full h-12 bg-black/20 border border-white/10 rounded-lg p-3 text-gray-400 focus:ring-indigo-400 focus:border-indigo-400 transition" style="color-scheme: dark;">
                </div>
                 <div class="w-full md:w-auto">
                    <label for="priority-input" class="text-sm font-medium text-gray-400 mb-2 block">Priority</label>
                    <select id="priority-input" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg px-3 focus:ring-indigo-400 focus:border-indigo-400 transition">
                        <option value="low" selected>Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                 <label class="text-sm font-medium text-gray-400 mb-2 block">Tags <span class="text-xs">(comma separated)</span></label>
                 <input type="text" id="tags-input" placeholder="e.g. work, personal" class="w-full bg-black/20 border border-white/10 text-gray-200 text-sm rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500">
            </div>
             <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                <button type="submit" id="add-task-btn" class="w-full text-white bg-indigo-500 hover:bg-indigo-600 focus:ring-4 focus:ring-indigo-500/50 font-medium rounded-lg px-6 py-3 transition duration-300 flex items-center justify-center gap-2 border border-indigo-400">
                    <span id="add-btn-text"><i class="fas fa-plus mr-2"></i>Add Task</span>
                    <div id="add-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                </button>
                <button type="button" id="suggest-tasks-btn" class="w-full text-white bg-purple-500 hover:bg-purple-600 focus:ring-4 focus:ring-purple-500/50 font-medium rounded-lg px-6 py-3 transition duration-300 flex items-center justify-center gap-2 border border-purple-400">
                    <i class="fas fa-magic-wand-sparkles"></i>
                    <span>✨ Suggest Tasks</span>
                </button>
            </div>
        </form>

        <!-- Filter Display -->
        <div id="filter-container" class="mb-4 text-center hidden">
             <span class="text-sm text-gray-400">Filtering by:</span>
            <span id="active-filter-tag" class="inline-block bg-indigo-500 text-white text-sm font-semibold mr-2 px-3 py-1 rounded-full"></span>
            <button id="clear-filter-btn" class="text-red-400 hover:text-red-300 text-sm">&times; clear</button>
        </div>
        
        <!-- Task List Header -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-300">Tasks for <span id="task-list-date"></span></h2>
            <div class="flex items-center gap-4">
                 <button id="smart-plan-btn" class="hidden text-sm text-white bg-teal-500 hover:bg-teal-600 rounded-full px-4 py-2 flex items-center gap-2 transition-all duration-300 border border-teal-400">
                    <i class="fas fa-brain"></i> <span>✨ Smart Plan</span>
                 </button>
                <div id="task-counter" class="text-sm font-medium text-gray-300 bg-black/20 border border-white/10 rounded-full px-3 py-1">0 tasks</div>
            </div>
        </div>
        
        <!-- Task List -->
        <div id="task-list" class="space-y-3 min-h-[100px]">
             <div id="empty-state" class="text-center py-8 px-4 border-2 border-dashed border-white/10 rounded-lg">
                <i class="fas fa-tasks text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">No tasks for this day.</p>
            </div>
        </div>

        <!-- Progress Bar & Footer -->
        <div class="mt-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-indigo-300">Daily Progress</span>
                <span id="progress-text" class="text-sm font-medium text-indigo-300">0%</span>
            </div>
            <div class="w-full bg-black/20 rounded-full h-2.5 mb-8 border border-white/10">
                <div id="progress-bar" class="bg-indigo-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <footer class="pt-6 border-t border-white/10 flex justify-between items-center">
                <button id="clear-all-btn" class="text-sm text-red-400 hover:text-red-300 transition flex items-center gap-2">
                    <i class="fas fa-trash-alt"></i> Clear All Tasks
                </button>
                <p id="copyright" class="text-sm text-gray-400"></p>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="suggest-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-md p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-4">✨ Suggest Tasks</h3>
            <p class="text-gray-300 mb-4">What's your goal? AI will break it down into smaller tasks.</p>
            <div>
                <input type="text" id="goal-input" placeholder="e.g., Plan a weekend trip" class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3">
                <div class="mt-4 flex justify-end gap-3">
                     <button type="button" id="cancel-suggest-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                    <button id="generate-tasks-btn" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition border border-purple-400 flex items-center justify-center gap-2">
                        <span id="generate-btn-text">Generate</span>
                        <div id="generate-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
         <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-4">Edit Task</h3>
            <form id="edit-task-form">
                <input type="hidden" id="edit-task-id">
                <div class="mb-4">
                    <label for="edit-task-text" class="text-sm font-medium text-gray-300 mb-2 block">Task</label>
                    <input type="text" id="edit-task-text" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3" required>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-task-time" class="text-sm font-medium text-gray-300 mb-2 block">Time <span class="opacity-75">(optional)</span></label>
                        <input type="time" id="edit-task-time" class="w-full h-12 bg-black/20 border border-white/10 rounded-lg p-3 text-gray-400" style="color-scheme: dark;">
                    </div>
                     <div>
                        <label for="edit-task-priority" class="text-sm font-medium text-gray-300 mb-2 block">Priority</label>
                        <select id="edit-task-priority" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg px-3">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit-task-tags" class="text-sm font-medium text-gray-300 mb-2 block">Tags</label>
                    <input type="text" id="edit-task-tags" class="w-full bg-black/20 border border-white/10 text-gray-200 text-sm rounded-lg p-3">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition border border-indigo-400">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-clear-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
         <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-md p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-2">Are you sure?</h3>
            <p class="text-gray-300 mb-6">This will permanently delete all tasks for all weeks. This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-clear-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                <button type="button" id="confirm-clear-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition border border-red-400">Delete All</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selectors ---
            const taskForm = document.getElementById('add-task-form');
            const taskInput = document.getElementById('task-input');
            const timeInput = document.getElementById('time-input');
            const priorityInput = document.getElementById('priority-input');
            const tagsInput = document.getElementById('tags-input');
            const taskList = document.getElementById('task-list');
            const taskCounter = document.getElementById('task-counter');
            const addTaskBtn = document.getElementById('add-task-btn');
            const addBtnText = document.getElementById('add-btn-text');
            const addSpinner = document.getElementById('add-spinner');
            const suggestTasksBtn = document.getElementById('suggest-tasks-btn');
            const weekDaysContainer = document.getElementById('week-days-container');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const currentWeekDisplay = document.getElementById('current-week-display');
            const newTaskDate = document.getElementById('new-task-date');
            const taskListDate = document.getElementById('task-list-date');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const copyrightEl = document.getElementById('copyright');

            const filterContainer = document.getElementById('filter-container');
            const activeFilterTag = document.getElementById('active-filter-tag');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const smartPlanBtn = document.getElementById('smart-plan-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            
            // Modal Selectors
            const suggestModal = document.getElementById('suggest-modal');
            const generateTasksBtn = document.getElementById('generate-tasks-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const generateSpinner = document.getElementById('generate-spinner');
            const goalInput = document.getElementById('goal-input');
            const cancelSuggestBtn = document.getElementById('cancel-suggest-btn');

            const editModal = document.getElementById('edit-modal');
            const editTaskForm = document.getElementById('edit-task-form');
            const editTaskId = document.getElementById('edit-task-id');
            const editTaskText = document.getElementById('edit-task-text');
            const editTaskTime = document.getElementById('edit-task-time');
            const editTaskPriority = document.getElementById('edit-task-priority');
            const editTaskTags = document.getElementById('edit-task-tags');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            
            // --- State ---
            let allTasks = [];
            let currentDate = new Date();
            let selectedDate = new Date();
            let currentFilter = null;
            const synth = new Tone.Synth().toDestination();

            // --- Date Formatting Helper ---
            const toISODateString = (date) => {
                const d = new Date(date);
                d.setHours(0,0,0,0);
                return d.toISOString().split('T')[0];
            };
            selectedDate = toISODateString(selectedDate);
            
            // --- Initialization ---
            const today = new Date();
            copyrightEl.innerHTML = `&copy; ${today.getFullYear()} Rodytech. All Rights Reserved.`;

            // --- Local Storage ---
            const saveTasks = () => localStorage.setItem('weeklyTasks', JSON.stringify(allTasks));
            const loadTasks = () => allTasks = JSON.parse(localStorage.getItem('weeklyTasks')) || [];

            // --- Gemini API Call ---
            async function callGemini(prompt) { 
                const apiKey = "AIzaSyBdt6QlYc-mAJfhharUi2w7zEzTVFZR104";
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                       return result.candidates[0].content.parts[0].text;
                    }
                    throw new Error("Invalid response structure from API.");
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    alert(`AI feature failed: ${error.message}`);
                    return null;
                }
             }
            
            // --- Core Functions ---
            const renderWeek = () => {
                weekDaysContainer.innerHTML = '';
                const weekStart = new Date(currentDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Start of the week (Sunday)
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                currentWeekDisplay.textContent = `${weekStart.toLocaleDateString('en-US', {month: 'long', day: 'numeric'})} - ${weekEnd.toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}`;

                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(day.getDate() + i);
                    const dayISO = toISODateString(day);
                    
                    const dayButton = document.createElement('button');
                    dayButton.dataset.date = dayISO;
                    dayButton.className = `day-selector p-2 rounded-lg text-center transition ${dayISO === selectedDate ? 'bg-indigo-500 text-white' : 'hover:bg-white/10'}`;
                    dayButton.innerHTML = `<div class="text-xs opacity-75">${day.toLocaleDateString('en-US', {weekday: 'short'})}</div><div class="font-bold text-lg">${day.getDate()}</div>`;
                    
                    dayButton.addEventListener('click', () => {
                        selectedDate = dayISO;
                        renderWeek();
                        renderTasks();
                    });
                    
                    weekDaysContainer.appendChild(dayButton);
                }
                const selectedDateObj = new Date(selectedDate);
                selectedDateObj.setMinutes(selectedDateObj.getMinutes() + selectedDateObj.getTimezoneOffset());
                newTaskDate.textContent = selectedDateObj.toLocaleDateString('en-US', {weekday: 'long'});
                taskListDate.textContent = selectedDateObj.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'});
            };

            const renderTasks = () => {
                const tasksForSelectedDay = allTasks.filter(task => task.date === selectedDate);
                const tasksToRender = currentFilter 
                    ? tasksForSelectedDay.filter(task => task.tags.includes(currentFilter))
                    : tasksForSelectedDay;

                const emptyState = document.getElementById('empty-state');
                taskList.innerHTML = '';
                if(emptyState) taskList.appendChild(emptyState);
                
                if (tasksToRender.length === 0) {
                    if (currentFilter) {
                        emptyState.innerHTML = `<i class="fas fa-search text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">No tasks found for tag "${currentFilter}".</p>`;
                    } else {
                        emptyState.innerHTML = `<i class="fas fa-tasks text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">No tasks for this day.</p>`;
                    }
                    emptyState.style.display = 'block';
                } else {
                     if(emptyState) emptyState.style.display = 'none';
                     tasksToRender.sort((a,b) => (a.time || "23:59").localeCompare(b.time || "23:59")).forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.dataset.id = task.id;
                         const priorityClasses = { low: 'border-l-blue-400', medium: 'border-l-yellow-400', high: 'border-l-red-400' };
                        taskElement.className = `task-item bg-black/10 p-4 rounded-lg shadow-md border-l-4 transition-all duration-300 border border-white/10 ${task.completed ? 'border-green-400' : priorityClasses[task.priority]}`;
                        if (task.completed) taskElement.classList.add('completed');
                        
                        const formattedTime = task.time ? new Date(`1970-01-01T${task.time}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                        const tagsHTML = (task.tags || []).map(tag => `<span class="tag-btn cursor-pointer text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full bg-black/20 hover:bg-indigo-500 transition text-gray-300 border border-white/10">${tag}</span>`).join('');

                        taskElement.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-4 flex-grow">
                                    <input type="checkbox" class="custom-checkbox h-5 w-5 rounded border-white/20 mt-1 cursor-pointer appearance-none border-2 shrink-0" ${task.completed ? 'checked' : ''}>
                                    <div class="flex-grow">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">${task.emoji}</span>
                                            <span class="task-text font-medium text-gray-200">${task.text}</span>
                                        </div>
                                        <div class="mt-2 flex items-center flex-wrap gap-y-2">
                                            ${task.time ? `<div class="text-sm text-gray-400 mr-4"><i class="far fa-clock mr-1"></i>${formattedTime}</div>` : ''}
                                            <div class="flex flex-wrap">${tagsHTML}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 shrink-0 ml-2">
                                    <button class="edit-btn text-gray-400 hover:text-indigo-400 transition"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-btn text-gray-400 hover:text-red-400 transition"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                         taskElement.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleComplete(task.id, e));
                         taskElement.querySelector('.delete-btn').addEventListener('click', () => removeTask(task.id));
                         taskElement.querySelector('.edit-btn').addEventListener('click', () => openEditModal(task.id));
                         taskElement.querySelectorAll('.tag-btn').forEach(tagBtn => {
                            tagBtn.addEventListener('click', () => filterByTag(tagBtn.textContent));
                        });
                        taskList.appendChild(taskElement);
                    });
                }
                updateUICounters(tasksForSelectedDay);
            };

            const updateUICounters = (currentTasks) => {
                taskCounter.textContent = `${currentTasks.length} task${currentTasks.length !== 1 ? 's' : ''}`;
                const completedTasks = currentTasks.filter(t => t.completed).length;
                const progressPercentage = currentTasks.length > 0 ? (completedTasks / currentTasks.length) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `${Math.round(progressPercentage)}%`;
                const hasUnscheduledTasks = currentTasks.some(t => !t.time);
                smartPlanBtn.classList.toggle('hidden', !hasUnscheduledTasks || currentTasks.length === 0);
            };

            const addTask = (task) => {
                allTasks.push(task);
                saveTasks();
                renderTasks();
            };

            const toggleComplete = (id, event) => {
                const task = allTasks.find(t => t.id === id);
                if (!task) return;
                
                if (!task.completed) {
                    const rect = event.target.getBoundingClientRect();
                    const origin = { x: (rect.left + rect.right) / 2 / window.innerWidth, y: (rect.top + rect.bottom) / 2 / window.innerHeight };
                    confetti({ particleCount: 100, spread: 70, origin: origin, colors: ['#818cf8', '#c084fc', '#f472b6', '#4ade80'] });
                    synth.triggerAttackRelease("C5", "8n");
                }
                
                task.completed = !task.completed;
                saveTasks();
                renderTasks();
            };
            
            const removeTask = (id) => {
                allTasks = allTasks.filter(task => task.id !== id);
                saveTasks();
                renderTasks();
            };

            const openModal = (modalEl) => {
                modalEl.classList.remove('invisible', 'opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            }

            const closeModal = (modalEl) => {
                modalEl.classList.add('invisible', 'opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
            }

            const openEditModal = (id) => {
                const task = allTasks.find(t => t.id === id);
                if (!task) return;
                editTaskId.value = task.id;
                editTaskText.value = task.text;
                editTaskTime.value = task.time;
                editTaskPriority.value = task.priority;
                editTaskTags.value = task.tags.join(', ');
                openModal(editModal);
            };

            const filterByTag = (tag) => {
                currentFilter = tag;
                filterContainer.classList.remove('hidden');
                activeFilterTag.textContent = `#${tag}`;
                renderTasks();
            };

            // --- Event Listeners ---
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskText = taskInput.value.trim();
                if (taskText === '') return;

                addTaskBtn.disabled = true;
                addSpinner.classList.remove('hidden');
                addBtnText.classList.add('hidden');
                
                const emojiPrompt = `Based on the task "${taskText}", suggest one single, relevant emoji. Only return the emoji itself.`;
                const emoji = await callGemini(emojiPrompt) || '📝';
                
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const currentTime = `${hours}:${minutes}`;

                const task = {
                    id: Date.now(),
                    date: selectedDate, // Assign to the selected date
                    text: taskText,
                    emoji: emoji.trim(),
                    time: timeInput.value || currentTime,
                    priority: priorityInput.value,
                    tags: tagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean),
                    completed: false
                };
                addTask(task);
                
                taskForm.reset();
                priorityInput.value = 'low';
                addTaskBtn.disabled = false;
                addSpinner.classList.add('hidden');
                addBtnText.classList.remove('hidden');
            });

            prevWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                renderWeek();
                renderTasks();
            });

            nextWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                renderWeek();
                renderTasks();
            });
            
            suggestTasksBtn.addEventListener('click', () => openModal(suggestModal));
            cancelSuggestBtn.addEventListener('click', () => closeModal(suggestModal));
            
             generateTasksBtn.addEventListener('click', async () => {
                const goal = goalInput.value.trim();
                if (!goal) return;

                generateBtnText.classList.add('hidden');
                generateSpinner.classList.remove('hidden');
                generateTasksBtn.disabled = true;
                
                const prompt = `Based on the goal "${goal}", suggest a list of 3 to 5 actionable tasks. Return a JSON array of strings. Example: ["Task 1", "Task 2"]`;
                const responseText = await callGemini(prompt);

                if (responseText) {
                    try {
                        const suggestedTaskTexts = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, ''));
                        
                        const taskPromises = suggestedTaskTexts.map(async (taskText) => {
                            const emojiPrompt = `Based on the task "${taskText}", suggest one single, relevant emoji. Only return the emoji itself.`;
                            const emoji = await callGemini(emojiPrompt) || '💡';
                            return {
                                id: Date.now() + Math.random(),
                                date: selectedDate,
                                text: taskText,
                                emoji: emoji.trim(),
                                time: '',
                                priority: 'medium',
                                tags: ['suggested', goal.split(' ')[0].toLowerCase()],
                                completed: false
                            };
                        });

                        const newTasks = await Promise.all(taskPromises);
                        newTasks.forEach(task => addTask(task));
                        
                        closeModal(suggestModal);
                        goalInput.value = '';
                    } catch (e) {
                        alert("The AI returned an unexpected format. Please try a different goal.");
                    }
                }
                
                generateBtnText.classList.remove('hidden');
                generateSpinner.classList.add('hidden');
                generateTasksBtn.disabled = false;
            });
            
            smartPlanBtn.addEventListener('click', async () => {
                const tasksForDay = allTasks.filter(t => t.date === selectedDate && !t.time);
                if (tasksForDay.length === 0) return;
                
                smartPlanBtn.innerHTML = `<div class="spinner h-5 w-5 rounded-full border-2 border-t-transparent"></div><span>Planning...</span>`;
                smartPlanBtn.disabled = true;

                const taskDescriptions = tasksForDay.map(t => `text: ${t.text}, priority: ${t.priority}`).join('; ');
                const prompt = `Here is a list of tasks for today with priorities: ${taskDescriptions}. Suggest a logical schedule starting from the current time. Assign a time (HH:mm format) for each task, considering the priority. Return a JSON object where keys are task descriptions and values are suggested times. Example: {"Task 1": "14:30", "Task 2": "16:00"}`;
                
                const responseText = await callGemini(prompt);

                if (responseText) {
                    try {
                        const schedule = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, ''));
                        allTasks = allTasks.map(task => {
                            if (task.date === selectedDate && schedule[task.text]) {
                                return { ...task, time: schedule[task.text] };
                            }
                            return task;
                        });
                        saveTasks();
                        renderTasks();
                    } catch (e) {
                         alert("The AI returned an unexpected schedule format. Please try again.");
                    }
                }

                smartPlanBtn.innerHTML = `<i class="fas fa-brain"></i> <span>✨ Smart Plan</span>`;
                smartPlanBtn.disabled = false;
            });

            editTaskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(editTaskId.value);
                allTasks = allTasks.map(task => {
                    if (task.id === id) {
                        return {
                            ...task,
                            text: editTaskText.value,
                            time: editTaskTime.value,
                            priority: editTaskPriority.value,
                            tags: editTaskTags.value.split(',').map(tag => tag.trim()).filter(tag => tag)
                        };
                    }
                    return task;
                });
                saveTasks();
                renderTasks();
                closeModal(editModal);
            });

            cancelEditBtn.addEventListener('click', () => closeModal(editModal));
            
            clearAllBtn.addEventListener('click', () => openModal(confirmClearModal));
            cancelClearBtn.addEventListener('click', () => closeModal(confirmClearModal));
            confirmClearBtn.addEventListener('click', () => {
                allTasks = [];
                saveTasks();
                renderTasks();
                closeModal(confirmClearModal);
            });

            clearFilterBtn.addEventListener('click', () => {
                currentFilter = null;
                filterContainer.classList.add('hidden');
                renderTasks();
            });

            // --- Initial Load ---
            loadTasks();
            renderWeek();
            renderTasks();
        });
    </script>
</body>
</html>
