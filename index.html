<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="AI Powered Smart Planner">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Smart Planner">
    
    <!-- Existing Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    
    <!-- Supabase Integration -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-auth.js?v=1.1"></script>
    <script>
        // Debug script to verify ApiClient is loaded
        console.log('Checking ApiClient availability after script load...');
        console.log('window.ApiClient:', typeof window.ApiClient);
        console.log('window.SupabaseAuth:', typeof window.SupabaseAuth);
        if (window.ApiClient) {
            console.log('ApiClient methods:', Object.getOwnPropertyNames(window.ApiClient));
            console.log('reorderTasks method:', typeof window.ApiClient.reorderTasks);
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item, .day-selector {
            transition: all 0.3s ease;
        }
        .task-item.removing {
            transform: scale(0.95);
            opacity: 0;
        }
        .task-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            z-index: 1000;
        }
        .task-item.drag-over {
            border-top: 3px solid #818cf8;
            margin-top: 8px;
        }
        .task-list-sortable {
            min-height: 60px;
        }
        .touch-dragging {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            transform: rotate(3deg);
            opacity: 0.8;
        }
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .custom-checkbox:checked {
            background-color: #818cf8; /* indigo-400 */
            border-color: #818cf8; /* indigo-400 */
        }
        .custom-checkbox:checked::before {
            content: 'âœ“'; color: white; display: block; text-align: center; line-height: 1.25rem; font-size: 0.875rem;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .spinner {
            border-top-color: #818cf8; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .glass-pane {
            background: rgba(255, 255, 255, 0.05); -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .background-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .background-orb {
            position: absolute; border-radius: 50%; filter: blur(80px); will-change: transform;
        }
        #orb1 {
            background: radial-gradient(circle, #4f46e5, transparent 60%); width: 400px; height: 400px; top: 10%; left: 15%; animation: move-orb1 20s infinite alternate ease-in-out;
        }
        #orb2 {
            background: radial-gradient(circle, #a855f7, transparent 60%); width: 300px; height: 300px; top: 50%; left: 60%; animation: move-orb2 25s infinite alternate ease-in-out;
        }
        @keyframes move-orb1 { from { transform: translate(0, 0); } to { transform: translate(100px, 50px); } }
        @keyframes move-orb2 { from { transform: translate(0, 0); } to { transform: translate(-80px, -60px); } }
        
        /* Celebration Modal Animations */
        @keyframes celebration-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        @keyframes celebration-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.6); }
        }
        
        @keyframes celebration-float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(3deg); }
        }
        
        @keyframes celebration-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .celebration-trophy {
            animation: celebration-bounce 2s infinite, celebration-glow 3s infinite;
        }
        
        .celebration-title {
            animation: celebration-scale 2s infinite ease-in-out;
        }
        
        .celebration-stats {
            animation: celebration-float 4s infinite ease-in-out;
        }
        
        .celebration-orb {
            animation: celebration-float 6s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="background-container">
        <div id="orb1" class="background-orb"></div>
        <div id="orb2" class="background-orb"></div>
    </div>
    
    <!-- Authentication Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="glass-pane rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="text-center mb-8">
                <svg class="w-16 h-16 mx-auto mb-4" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="logoGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#a855f7; stop-opacity:1" /><stop offset="100%" style="stop-color:#4f46e5; stop-opacity:1" /></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="50" cy="50" r="45" fill="none" stroke="url(#logoGradient)" stroke-width="4" style="filter:url(#glow)"/><path d="M30 50 L45 65 L70 40" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h1 class="text-2xl font-bold text-gray-100 mb-2">Smart Planner</h1>
                <p class="text-gray-400">Sign in to access your personal planner</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                    <input type="email" id="login-email" name="email" required 
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="Enter your email">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                    <input type="password" id="login-password" name="password" required 
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="Enter your password">
                </div>
                <button type="submit" id="login-btn" 
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                    <span id="login-btn-text">Sign In</span>
                    <div id="login-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-400 text-sm">Don't have an account?</p>
                <button id="show-register-btn" class="text-indigo-400 hover:text-indigo-300 font-medium">Create Account</button>
            </div>

            <!-- Register Form (Initially Hidden) -->
            <form id="register-form" class="space-y-4 hidden">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-100">Create Account</h2>
                    <p class="text-gray-400 text-sm">Join to start planning your week</p>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                    <input type="email" id="register-email" name="email" required 
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="Enter your email">
                </div>
                <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-400 mb-2">Username (Optional)</label>
                    <input type="text" id="register-username" name="username" 
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="Choose a display name">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                    <input type="password" id="register-password" name="password" required minlength="6"
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="At least 6 characters">
                </div>
                <div>
                    <label for="register-password-confirm" class="block text-sm font-medium text-gray-400 mb-2">Confirm Password</label>
                    <input type="password" id="register-password-confirm" name="passwordConfirm" required minlength="6"
                           class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" 
                           placeholder="Confirm your password">
                </div>
                <button type="submit" id="register-btn" 
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                    <span id="register-btn-text">Create Account</span>
                    <div id="register-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                </button>
            </form>

            <div id="register-switch" class="mt-6 text-center hidden">
                <p class="text-gray-400 text-sm">Already have an account?</p>
                <button id="show-login-btn" class="text-indigo-400 hover:text-indigo-300 font-medium">Sign In</button>
            </div>

            <!-- Error/Success Messages -->
            <div id="auth-message" class="mt-4 p-3 rounded-lg hidden">
                <p id="auth-message-text" class="text-sm text-center"></p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (Hidden until authenticated) -->
    <div id="main-app" class="relative z-10 w-full max-w-4xl mx-auto my-8 glass-pane rounded-2xl shadow-2xl p-6 md:p-8 hidden">

        <!-- Header -->
        <div class="flex justify-between items-start mb-6">
            <div class="flex-1"></div>
            <div class="text-center">
                <svg class="w-20 h-20 mx-auto mb-4" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="logoGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#a855f7; stop-opacity:1" /><stop offset="100%" style="stop-color:#4f46e5; stop-opacity:1" /></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="50" cy="50" r="45" fill="none" stroke="url(#logoGradient)" stroke-width="4" style="filter:url(#glow)"/><path d="M30 50 L45 65 L70 40" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-100">Smart Planner</h1>
                <p id="current-week-display" class="text-gray-400 mt-2 text-lg"></p>
            </div>
            <div class="flex-1 flex justify-end">
                <!-- User Menu -->
                <div class="relative">
                    <button id="user-menu-btn" class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-lg px-3 py-2 hover:bg-white/10 transition">
                        <i class="fas fa-user-circle text-indigo-400"></i>
                        <span id="user-display-name" class="text-sm text-gray-300">User</span>
                        <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                    </button>
                    <div id="user-menu" class="absolute right-0 mt-2 w-48 glass-pane rounded-lg shadow-lg py-2 hidden z-10">
                        <div class="px-3 py-2 border-b border-white/10">
                            <p class="text-xs text-gray-400">Signed in as</p>
                            <p id="user-menu-name" class="text-sm font-medium text-gray-200">User</p>
                        </div>
                        <button id="logout-btn" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-white/5 transition flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Week Navigator -->
        <div class="flex items-center justify-between mb-6">
            <button id="prev-week-btn" class="p-2 rounded-full hover:bg-white/10 transition"><i class="fas fa-chevron-left"></i></button>
            <div id="week-days-container" class="flex-grow grid grid-cols-7 gap-2 mx-4">
                <!-- Day selectors will be generated here -->
            </div>
            <button id="next-week-btn" class="p-2 rounded-full hover:bg-white/10 transition"><i class="fas fa-chevron-right"></i></button>
        </div>


        <!-- Add Task Form -->
        <form id="add-task-form" class="bg-white/5 p-4 rounded-lg shadow-inner mb-6 border border-white/10">
            <div class="flex flex-col md:flex-row items-end gap-4">
                 <div class="flex-grow w-full">
                    <label class="text-sm font-medium text-gray-400 mb-2 block">New Task for <span id="new-task-date" class="font-bold"></span></label>
                    <input type="text" id="task-input" placeholder="What's your next task?" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500" required>
                </div>
                 <div class="w-full md:w-auto">
                    <label class="text-sm font-medium text-gray-400 mb-2 block">Time <span class="opacity-75">(optional)</span></label>
                    <input type="time" id="time-input" class="w-full h-12 bg-black/20 border border-white/10 rounded-lg p-3 text-gray-400 focus:ring-indigo-400 focus:border-indigo-400 transition" style="color-scheme: dark;">
                </div>
                 <div class="w-full md:w-auto">
                    <label for="priority-input" class="text-sm font-medium text-gray-400 mb-2 block">Priority</label>
                    <select id="priority-input" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg px-3 focus:ring-indigo-400 focus:border-indigo-400 transition">
                        <option value="low" selected>Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                 <label class="text-sm font-medium text-gray-400 mb-2 block">Tags <span class="text-xs">(comma separated)</span></label>
                 <input type="text" id="tags-input" placeholder="e.g. work, personal" class="w-full bg-black/20 border border-white/10 text-gray-200 text-sm rounded-lg p-3 focus:ring-indigo-400 focus:border-indigo-400 transition placeholder:text-gray-500">
            </div>
             <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                <button type="submit" id="add-task-btn" class="w-full text-white bg-indigo-500 hover:bg-indigo-600 focus:ring-4 focus:ring-indigo-500/50 font-medium rounded-lg px-6 py-3 transition duration-300 flex items-center justify-center gap-2 border border-indigo-400">
                    <span id="add-btn-text"><i class="fas fa-plus mr-2"></i>Add Task</span>
                    <div id="add-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                </button>
                <button type="button" id="suggest-tasks-btn" class="w-full text-white bg-purple-500 hover:bg-purple-600 focus:ring-4 focus:ring-purple-500/50 font-medium rounded-lg px-6 py-3 transition duration-300 flex items-center justify-center gap-2 border border-purple-400">
                    <i class="fas fa-magic-wand-sparkles"></i>
                    <span>âœ¨ Suggest Tasks</span>
                </button>
            </div>
        </form>

        <!-- Filter Display -->
        <div id="filter-container" class="mb-4 text-center hidden">
             <span class="text-sm text-gray-400">Filtering by:</span>
            <span id="active-filter-tag" class="inline-block bg-indigo-500 text-white text-sm font-semibold mr-2 px-3 py-1 rounded-full"></span>
            <button id="clear-filter-btn" class="text-red-400 hover:text-red-300 text-sm">&times; clear</button>
        </div>
        
        <!-- Task List Header -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-300">
                Tasks for <span id="task-list-date"></span>
                <span id="archive-indicator" class="hidden text-sm font-normal text-amber-400 ml-2">(Archive View)</span>
            </h2>
            <div class="flex items-center gap-3">
                <!-- Archive Toggle Button -->
                <button id="archive-toggle-btn" class="text-sm text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center gap-2 bg-black/20 border border-white/10 rounded-full px-3 py-1.5 hover:bg-amber-500/10 hover:border-amber-400/30">
                    <i class="fas fa-archive text-xs"></i>
                    <span id="archive-toggle-text">Archive</span>
                    <span id="archive-count" class="text-xs bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
                
                 <button id="smart-plan-btn" class="hidden text-sm text-white bg-teal-500 hover:bg-teal-600 rounded-full px-4 py-2 flex items-center gap-2 transition-all duration-300 border border-teal-400">
                    <i class="fas fa-brain"></i> <span>âœ¨ Smart Plan</span>
                 </button>
                <div id="task-counter" class="text-sm font-medium text-gray-300 bg-black/20 border border-white/10 rounded-full px-3 py-1">0 tasks</div>
            </div>
        </div>
        
        <!-- Task List -->
        <div id="task-list" class="task-list-sortable space-y-3 min-h-[100px]">
             <div id="empty-state" class="text-center py-8 px-4 border-2 border-dashed border-white/10 rounded-lg">
                <i class="fas fa-tasks text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">No tasks for this day.</p>
            </div>
        </div>

        <!-- Progress Bar & Footer -->
        <div class="mt-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-indigo-300">Daily Progress</span>
                <span id="progress-text" class="text-sm font-medium text-indigo-300">0%</span>
            </div>
            <div class="w-full bg-black/20 rounded-full h-2.5 mb-8 border border-white/10">
                <div id="progress-bar" class="bg-indigo-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <footer class="pt-6 border-t border-white/10 flex justify-between items-center">
                <button id="clear-all-btn" class="text-sm text-red-400 hover:text-red-300 transition flex items-center gap-2">
                    <i class="fas fa-trash-alt"></i> Clear All Tasks
                </button>
                <p id="copyright" class="text-sm text-gray-400"></p>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="suggest-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-md p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-4">âœ¨ Suggest Tasks</h3>
            <p class="text-gray-300 mb-4">What's your goal? AI will break it down into smaller tasks.</p>
            <div>
                <input type="text" id="goal-input" placeholder="e.g., Plan a weekend trip" class="w-full bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3">
                <div class="mt-4 flex justify-end gap-3">
                     <button type="button" id="cancel-suggest-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                    <button id="generate-tasks-btn" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition border border-purple-400 flex items-center justify-center gap-2">
                        <span id="generate-btn-text">Generate</span>
                        <div id="generate-spinner" class="spinner h-5 w-5 rounded-full border-2 border-t-transparent hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
         <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-4">Edit Task</h3>
            <form id="edit-task-form">
                <input type="hidden" id="edit-task-id">
                <div class="mb-4">
                    <label for="edit-task-text" class="text-sm font-medium text-gray-300 mb-2 block">Task</label>
                    <input type="text" id="edit-task-text" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg p-3" required>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-task-time" class="text-sm font-medium text-gray-300 mb-2 block">Time <span class="opacity-75">(optional)</span></label>
                        <input type="time" id="edit-task-time" class="w-full h-12 bg-black/20 border border-white/10 rounded-lg p-3 text-gray-400" style="color-scheme: dark;">
                    </div>
                     <div>
                        <label for="edit-task-priority" class="text-sm font-medium text-gray-300 mb-2 block">Priority</label>
                        <select id="edit-task-priority" class="w-full h-12 bg-black/20 border border-white/10 text-gray-200 rounded-lg px-3">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit-task-tags" class="text-sm font-medium text-gray-300 mb-2 block">Tags</label>
                    <input type="text" id="edit-task-tags" class="w-full bg-black/20 border border-white/10 text-gray-200 text-sm rounded-lg p-3">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition border border-indigo-400">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-clear-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0">
         <div class="modal-content glass-pane rounded-2xl shadow-lg w-full max-w-md p-6 transform scale-95">
            <h3 class="text-xl font-bold text-white mb-2">Are you sure?</h3>
            <p class="text-gray-300 mb-6">This will permanently delete all tasks for all weeks. This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-clear-btn" class="px-6 py-2 bg-black/20 text-white rounded-lg hover:bg-white/10 transition border border-white/10">Cancel</button>
                <button type="button" id="confirm-clear-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition border border-red-400">Delete All</button>
            </div>
        </div>
    </div>

    <!-- All Tasks Completed Celebration Modal -->
    <div id="celebration-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 invisible opacity-0 z-60">
        <div class="modal-content glass-pane rounded-3xl shadow-2xl w-full max-w-lg p-8 transform scale-95 text-center relative overflow-hidden">
            <!-- Animated background elements -->
            <div class="absolute inset-0 pointer-events-none">
                <div class="celebration-orb absolute w-32 h-32 rounded-full opacity-20 animate-pulse" style="background: radial-gradient(circle, #fbbf24, transparent 70%); top: -10%; left: -10%;"></div>
                <div class="celebration-orb absolute w-24 h-24 rounded-full opacity-30 animate-pulse" style="background: radial-gradient(circle, #a855f7, transparent 70%); top: 20%; right: -5%; animation-delay: 0.5s;"></div>
                <div class="celebration-orb absolute w-20 h-20 rounded-full opacity-25 animate-pulse" style="background: radial-gradient(circle, #10b981, transparent 70%); bottom: 10%; left: 20%; animation-delay: 1s;"></div>
            </div>
            
            <!-- Main content -->
            <div class="relative z-10">
                <!-- Trophy icon with bounce animation -->
                <div class="celebration-trophy mb-6 animate-bounce">
                    <i class="fas fa-trophy text-6xl text-yellow-400 drop-shadow-lg"></i>
                </div>
                
                <!-- Animated title -->
                <h2 class="celebration-title text-3xl font-bold text-white mb-4 animate-pulse">
                    ðŸŽ‰ Congratulations! ðŸŽ‰
                </h2>
                
                <!-- Celebration message -->
                <p class="celebration-message text-lg text-gray-200 mb-6 leading-relaxed">
                    Amazing work! You've completed all your tasks for today. 
                    <br>
                    <span class="text-emerald-400 font-semibold">You're absolutely crushing it!</span>
                </p>
                
                <!-- Animated stats -->
                <div class="celebration-stats bg-white/10 rounded-2xl p-4 mb-6 border border-white/20">
                    <div class="flex justify-center items-center gap-4">
                        <div class="text-center">
                            <div id="celebration-task-count" class="text-2xl font-bold text-emerald-400">0</div>
                            <div class="text-sm text-gray-300">Tasks Completed</div>
                        </div>
                        <div class="w-px h-8 bg-white/20"></div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-400">100%</div>
                            <div class="text-sm text-gray-300">Progress</div>
                        </div>
                    </div>
                </div>
                
                <!-- Motivational quote -->
                <div class="celebration-quote text-center mb-6">
                    <p class="text-gray-300 italic text-sm" id="celebration-quote">
                        "Success is the sum of small efforts repeated day in and day out."
                    </p>
                </div>
                
                <!-- Action buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="add-tomorrow-tasks-btn" 
                            class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2 border border-indigo-400">
                        <i class="fas fa-plus"></i>
                        Plan Tomorrow
                    </button>
                    <button id="close-celebration-btn" 
                            class="flex-1 bg-white/10 hover:bg-white/20 text-white font-medium py-3 px-6 rounded-lg transition duration-300 border border-white/20">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Debug: Check if ApiClient is available
            console.log('DOMContentLoaded - ApiClient available:', typeof ApiClient !== 'undefined');
            console.log('DOMContentLoaded - window.ApiClient available:', typeof window.ApiClient !== 'undefined');
            console.log('DOMContentLoaded - SupabaseAuth available:', typeof SupabaseAuth !== 'undefined');
            console.log('DOMContentLoaded - window.SupabaseAuth available:', typeof window.SupabaseAuth !== 'undefined');
            
            // If ApiClient is not available globally, try to use window.ApiClient
            if (typeof ApiClient === 'undefined' && typeof window.ApiClient !== 'undefined') {
                console.log('Using window.ApiClient as fallback');
                window.ApiClient = window.ApiClient; // This ensures global access
            }
            
            // Initialize Supabase
            if (!initializeSupabase()) {
                console.error('Failed to initialize Supabase');
                return;
            }
            
            // --- Authentication Management ---
            let currentUser = null;
            
            // Auth element selectors
            const authModal = document.getElementById('auth-modal');
            const mainApp = document.getElementById('main-app');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const registerSwitch = document.getElementById('register-switch');
            const authMessage = document.getElementById('auth-message');
            const authMessageText = document.getElementById('auth-message-text');
            const userDisplayName = document.getElementById('user-display-name');
            const userMenuName = document.getElementById('user-menu-name');
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenu = document.getElementById('user-menu');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Check authentication status on load
            async function checkAuth() {
                try {
                    const authStatus = await SupabaseAuth.checkAuth();
                    
                    if (authStatus.authenticated) {
                        currentUser = authStatus.user;
                        showMainApp();
                    } else {
                        showAuthModal();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    showAuthModal();
                }
            }
            
            function showAuthModal() {
                authModal.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
            
            function showMainApp() {
                authModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                updateUserDisplay();
            }
            
            function updateUserDisplay() {
                if (currentUser) {
                    userDisplayName.textContent = currentUser.username;
                    userMenuName.textContent = currentUser.username;
                }
            }
            
            function showMessage(message, type = 'error') {
                authMessage.className = `mt-4 p-3 rounded-lg ${type === 'success' ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'}`;
                authMessageText.className = `text-sm text-center ${type === 'success' ? 'text-emerald-400' : 'text-red-400'}`;
                authMessageText.textContent = message;
                authMessage.classList.remove('hidden');
                
                setTimeout(() => {
                    authMessage.classList.add('hidden');
                }, 5000);
            }
            
            // Form switching
            showRegisterBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerSwitch.classList.remove('hidden');
                authMessage.classList.add('hidden');
            });
            
            showLoginBtn.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                registerSwitch.classList.add('hidden');
                authMessage.classList.add('hidden');
            });
            
            // User menu toggle
            userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userMenu.classList.toggle('hidden');
            });
            
            // Close user menu when clicking outside
            document.addEventListener('click', () => {
                userMenu.classList.add('hidden');
            });
            
            // Login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const loginBtn = document.getElementById('login-btn');
                const loginBtnText = document.getElementById('login-btn-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                // Show loading state
                loginBtnText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');
                loginBtn.disabled = true;
                
                try {
                    const result = await SupabaseAuth.login(email, password);
                    
                    if (result.success) {
                        currentUser = result.user;
                        showMainApp();
                        showMessage('Welcome back!', 'success');
                    } else {
                        showMessage(result.error || 'Login failed');
                    }
                } catch (error) {
                    showMessage('Network error. Please try again.');
                } finally {
                    // Reset loading state
                    loginBtnText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                    loginBtn.disabled = false;
                }
            });
            
            // Register form submission
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('register-email').value;
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                const registerBtn = document.getElementById('register-btn');
                const registerBtnText = document.getElementById('register-btn-text');
                const registerSpinner = document.getElementById('register-spinner');
                
                if (password !== passwordConfirm) {
                    showMessage('Passwords do not match');
                    return;
                }
                
                // Show loading state
                registerBtnText.classList.add('hidden');
                registerSpinner.classList.remove('hidden');
                registerBtn.disabled = true;
                
                try {
                    const result = await SupabaseAuth.register(email, password, username);
                    
                    if (result.success) {
                        if (result.needsConfirmation) {
                            showMessage(result.message, 'success');
                        } else {
                            currentUser = result.user;
                            showMainApp();
                            showMessage('Account created successfully!', 'success');
                        }
                    } else {
                        showMessage(result.error || 'Registration failed');
                    }
                } catch (error) {
                    showMessage('Network error. Please try again.');
                } finally {
                    // Reset loading state
                    registerBtnText.classList.remove('hidden');
                    registerSpinner.classList.add('hidden');
                    registerBtn.disabled = false;
                }
            });
            
            // Logout functionality
            logoutBtn.addEventListener('click', async () => {
                try {
                    const result = await SupabaseAuth.logout();
                    if (result.success) {
                        currentUser = null;
                        showAuthModal();
                        
                        // Reset forms
                        loginForm.reset();
                        registerForm.reset();
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
            
            // Initialize authentication check
            await checkAuth();
            
            // Only initialize main app if authenticated
            if (!currentUser) return;
            
            // --- Element Selectors ---
            const taskForm = document.getElementById('add-task-form');
            const taskInput = document.getElementById('task-input');
            const timeInput = document.getElementById('time-input');
            const priorityInput = document.getElementById('priority-input');
            const tagsInput = document.getElementById('tags-input');
            const taskList = document.getElementById('task-list');
            const taskCounter = document.getElementById('task-counter');
            const addTaskBtn = document.getElementById('add-task-btn');
            const addBtnText = document.getElementById('add-btn-text');
            const addSpinner = document.getElementById('add-spinner');
            const suggestTasksBtn = document.getElementById('suggest-tasks-btn');
            const weekDaysContainer = document.getElementById('week-days-container');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const currentWeekDisplay = document.getElementById('current-week-display');
            const newTaskDate = document.getElementById('new-task-date');
            const taskListDate = document.getElementById('task-list-date');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const copyrightEl = document.getElementById('copyright');

            const filterContainer = document.getElementById('filter-container');
            const activeFilterTag = document.getElementById('active-filter-tag');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const smartPlanBtn = document.getElementById('smart-plan-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            
            // Modal Selectors
            const suggestModal = document.getElementById('suggest-modal');
            const generateTasksBtn = document.getElementById('generate-tasks-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const generateSpinner = document.getElementById('generate-spinner');
            const goalInput = document.getElementById('goal-input');
            const cancelSuggestBtn = document.getElementById('cancel-suggest-btn');

            const editModal = document.getElementById('edit-modal');
            const editTaskForm = document.getElementById('edit-task-form');
            const editTaskId = document.getElementById('edit-task-id');
            const editTaskText = document.getElementById('edit-task-text');
            const editTaskTime = document.getElementById('edit-task-time');
            const editTaskPriority = document.getElementById('edit-task-priority');
            const editTaskTags = document.getElementById('edit-task-tags');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            
            // Celebration modal selectors
            const celebrationModal = document.getElementById('celebration-modal');
            const celebrationTaskCount = document.getElementById('celebration-task-count');
            const celebrationQuote = document.getElementById('celebration-quote');
            const addTomorrowTasksBtn = document.getElementById('add-tomorrow-tasks-btn');
            const closeCelebrationBtn = document.getElementById('close-celebration-btn');
            
            // Archive selectors
            const archiveToggleBtn = document.getElementById('archive-toggle-btn');
            const archiveToggleText = document.getElementById('archive-toggle-text');
            const archiveCount = document.getElementById('archive-count');
            const archiveIndicator = document.getElementById('archive-indicator');
            
            // --- State ---
            let allTasks = [];
            let currentDate = new Date();
            let selectedDate = new Date();
            let currentFilter = null;
            let synth = null;
            let audioContextStarted = false;
            let showingArchive = false;
            let positionColumnExists = true; // Assume it exists until we find out otherwise
            
            // Initialize audio context after user interaction
            const initAudio = async () => {
                if (!audioContextStarted) {
                    try {
                        await Tone.start();
                        synth = new Tone.Synth().toDestination();
                        audioContextStarted = true;
                        console.log('Audio context started successfully');
                    } catch (error) {
                        console.warn('Audio initialization failed:', error);
                    }
                }
            };

            // --- Celebration Functions ---
            const motivationalQuotes = [
                "Success is the sum of small efforts repeated day in and day out.",
                "You are what you do, not what you say you'll do.",
                "The way to get started is to quit talking and begin doing.",
                "Productivity is being able to do things that you were never able to do before.",
                "Excellence is never an accident. It is always the result of high intention.",
                "The future depends on what you do today.",
                "Don't wait for opportunity. Create it.",
                "Success is where preparation and opportunity meet."
            ];

            const checkAllTasksCompleted = () => {
                const tasksForToday = allTasks.filter(task => !currentFilter || task.tags.includes(currentFilter));
                if (tasksForToday.length > 0) {
                    const allCompleted = tasksForToday.every(task => task.completed);
                    return { allCompleted, totalTasks: tasksForToday.length };
                }
                return { allCompleted: false, totalTasks: 0 };
            };

            const triggerCelebration = async (taskCount) => {
                // Epic confetti explosion
                const duration = 3000;
                const end = Date.now() + duration;
                
                const colors = ['#818cf8', '#c084fc', '#f472b6', '#4ade80', '#fbbf24', '#f97316'];
                
                (function frame() {
                    if (typeof confetti === 'function') {
                        confetti({
                            particleCount: 15,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: colors
                        });
                        confetti({
                            particleCount: 15,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: colors
                        });
                    }
                    
                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                })();
                
                // Play celebration sound sequence
                try {
                    if (synth && audioContextStarted) {
                        synth.triggerAttackRelease("C5", "8n");
                        setTimeout(() => synth.triggerAttackRelease("E5", "8n"), 200);
                        setTimeout(() => synth.triggerAttackRelease("G5", "8n"), 400);
                        setTimeout(() => synth.triggerAttackRelease("C6", "4n"), 600);
                    }
                } catch (error) {
                    console.warn('Celebration sound failed:', error);
                }
                
                // Update celebration modal content
                celebrationTaskCount.textContent = taskCount;
                const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                celebrationQuote.textContent = randomQuote;
                
                // Show celebration modal with delay for effect
                setTimeout(() => {
                    openModal(celebrationModal);
                }, 800);
            };

            // --- Date Formatting Helper ---
            const toISODateString = (date) => {
                const d = new Date(date);
                d.setHours(0,0,0,0);
                return d.toISOString().split('T')[0];
            };
            selectedDate = toISODateString(selectedDate);
            
            // --- Initialization ---
            const today = new Date();
            copyrightEl.innerHTML = `&copy; ${today.getFullYear()} RodyTech LLC. All Rights Reserved.`;

            // --- API Functions ---
            const fetchTasks = async (date, includeArchived = false) => {
                try {
                    return await ApiClient.fetchTasks(date, includeArchived);
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                    return [];
                }
            };

            const saveTask = async (task) => {
                try {
                    return await ApiClient.saveTask(task);
                } catch (error) {
                    console.error('Error saving task:', error);
                    throw error;
                }
            };

            const updateTask = async (id, updates) => {
                try {
                    return await ApiClient.updateTask(id, updates);
                } catch (error) {
                    console.error('Error updating task:', error);
                    throw error;
                }
            };

            const deleteTask = async (id) => {
                try {
                    return await ApiClient.deleteTask(id);
                } catch (error) {
                    console.error('Error deleting task:', error);
                    throw error;
                }
            };

            const clearAllTasks = async () => {
                try {
                    return await ApiClient.clearAllTasks();
                } catch (error) {
                    console.error('Error clearing tasks:', error);
                    throw error;
                }
            };

            // --- Archive API Functions ---
            const archiveCompletedTasks = async (date) => {
                try {
                    return await ApiClient.archiveTasks(date);
                } catch (error) {
                    console.error('Error archiving tasks:', error);
                    throw error;
                }
            };

            const unarchiveTasks = async (taskIds) => {
                try {
                    return await ApiClient.unarchiveTasks(taskIds);
                } catch (error) {
                    console.error('Error unarchiving tasks:', error);
                    throw error;
                }
            };

            const updateArchiveUI = async () => {
                try {
                    // Get archived tasks count for current date
                    const archivedTasks = await fetchTasks(selectedDate, true);
                    const archivedCount = archivedTasks.filter(task => task.archived).length;
                    
                    if (archivedCount > 0) {
                        archiveCount.textContent = archivedCount;
                        archiveCount.classList.remove('hidden');
                    } else {
                        archiveCount.classList.add('hidden');
                    }
                    
                    // Update UI based on current view
                    if (showingArchive) {
                        archiveToggleText.textContent = 'Active';
                        archiveIndicator.classList.remove('hidden');
                        archiveToggleBtn.classList.add('bg-amber-500/10', 'border-amber-400/30', 'text-amber-400');
                        archiveToggleBtn.classList.remove('bg-black/20', 'border-white/10', 'text-gray-400');
                    } else {
                        archiveToggleText.textContent = 'Archive';
                        archiveIndicator.classList.add('hidden');
                        archiveToggleBtn.classList.remove('bg-amber-500/10', 'border-amber-400/30', 'text-amber-400');
                        archiveToggleBtn.classList.add('bg-black/20', 'border-white/10', 'text-gray-400');
                    }
                } catch (error) {
                    console.error('Error updating archive UI:', error);
                }
            };

            // --- Gemini API Call ---
            async function callGemini(prompt) { 
                try {
                    return await ApiClient.callGemini(prompt);
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    alert(`AI feature failed: ${error.message}`);
                    return null;
                }
            }

            // --- Core Functions ---
            const renderWeek = () => {
                weekDaysContainer.innerHTML = '';
                const weekStart = new Date(currentDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Start of the week (Sunday)
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                currentWeekDisplay.textContent = `${weekStart.toLocaleDateString('en-US', {month: 'long', day: 'numeric'})} - ${weekEnd.toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}`;

                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(day.getDate() + i);
                    const dayISO = toISODateString(day);
                    
                    const dayButton = document.createElement('button');
                    dayButton.dataset.date = dayISO;
                    dayButton.className = `day-selector p-2 rounded-lg text-center transition ${dayISO === selectedDate ? 'bg-indigo-500 text-white' : 'hover:bg-white/10'}`;
                    dayButton.innerHTML = `<div class="text-xs opacity-75">${day.toLocaleDateString('en-US', {weekday: 'short'})}</div><div class="font-bold text-lg">${day.getDate()}</div>`;
                    
                    dayButton.addEventListener('click', () => {
                        selectedDate = dayISO;
                        renderWeek();
                        renderTasks();
                    });
                    
                    weekDaysContainer.appendChild(dayButton);
                }
                const selectedDateObj = new Date(selectedDate);
                selectedDateObj.setMinutes(selectedDateObj.getMinutes() + selectedDateObj.getTimezoneOffset());
                newTaskDate.textContent = selectedDateObj.toLocaleDateString('en-US', {weekday: 'long'});
                taskListDate.textContent = selectedDateObj.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'});
            };

            // --- Drag and Drop Functions ---
            let draggedElement = null;
            let draggedTaskId = null;
            let touchDragClone = null;
            let touchStartY = 0;
            let touchStartX = 0;
            let isTouchDragging = false;
            
            const setupDragAndDrop = (taskElement) => {
                taskElement.addEventListener('dragstart', (e) => {
                    draggedElement = taskElement;
                    draggedTaskId = parseInt(taskElement.dataset.id);
                    taskElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', taskElement.outerHTML);
                });
                
                taskElement.addEventListener('dragend', () => {
                    taskElement.classList.remove('dragging');
                    // Clean up any drag-over indicators
                    document.querySelectorAll('.task-item').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    draggedElement = null;
                    draggedTaskId = null;
                });
                
                taskElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (draggedElement && draggedElement !== taskElement) {
                        // Remove previous drag-over indicators
                        document.querySelectorAll('.task-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        
                        // Add drag-over indicator
                        taskElement.classList.add('drag-over');
                    }
                });
                
                taskElement.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    taskElement.classList.remove('drag-over');
                    
                    if (draggedElement && draggedElement !== taskElement) {
                        await handleTaskReorder(draggedTaskId, parseInt(taskElement.dataset.id));
                    }
                });
                
                taskElement.addEventListener('dragleave', (e) => {
                    // Only remove drag-over if we're actually leaving the element
                    if (!taskElement.contains(e.relatedTarget)) {
                        taskElement.classList.remove('drag-over');
                    }
                });
                
                // Touch events for mobile drag and drop
                const dragHandle = taskElement.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        touchStartY = touch.clientY;
                        touchStartX = touch.clientX;
                        draggedElement = taskElement;
                        draggedTaskId = parseInt(taskElement.dataset.id);
                        
                        // Create a clone for visual feedback
                        touchDragClone = taskElement.cloneNode(true);
                        touchDragClone.classList.add('touch-dragging');
                        touchDragClone.style.width = taskElement.offsetWidth + 'px';
                        touchDragClone.style.left = touchStartX - (taskElement.offsetWidth / 2) + 'px';
                        touchDragClone.style.top = touchStartY - 20 + 'px';
                        document.body.appendChild(touchDragClone);
                        
                        taskElement.classList.add('dragging');
                        isTouchDragging = true;
                    });
                    
                    dragHandle.addEventListener('touchmove', (e) => {
                        if (!isTouchDragging || !touchDragClone) return;
                        
                        e.preventDefault();
                        const touch = e.touches[0];
                        
                        // Update clone position
                        touchDragClone.style.left = touch.clientX - (touchDragClone.offsetWidth / 2) + 'px';
                        touchDragClone.style.top = touch.clientY - 20 + 'px';
                        
                        // Find element under touch
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const taskBelow = elementBelow?.closest('.task-item');
                        
                        // Clear previous drag-over indicators
                        document.querySelectorAll('.task-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        
                        // Add drag-over to target
                        if (taskBelow && taskBelow !== taskElement) {
                            taskBelow.classList.add('drag-over');
                        }
                    });
                    
                    dragHandle.addEventListener('touchend', async (e) => {
                        if (!isTouchDragging) return;
                        
                        e.preventDefault();
                        const touch = e.changedTouches[0];
                        
                        // Clean up
                        if (touchDragClone) {
                            document.body.removeChild(touchDragClone);
                            touchDragClone = null;
                        }
                        
                        taskElement.classList.remove('dragging');
                        document.querySelectorAll('.task-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        
                        // Find drop target
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const taskBelow = elementBelow?.closest('.task-item');
                        
                        if (taskBelow && taskBelow !== taskElement) {
                            const targetId = parseInt(taskBelow.dataset.id);
                            await handleTaskReorder(draggedTaskId, targetId);
                        }
                        
                        // Reset state
                        isTouchDragging = false;
                        draggedElement = null;
                        draggedTaskId = null;
                    });
                }
            };
            
            const handleTaskReorder = async (draggedId, targetId, placement = 'before') => {
                try {
                    // Check if user is authenticated before proceeding
                    if (!currentUser) {
                        alert('Please log in to reorder tasks.');
                        return;
                    }
                    
                    // Get current tasks order
                    const taskElements = Array.from(taskList.querySelectorAll('.task-item'));
                    const draggedElement = taskElements.find(el => parseInt(el.dataset.id) === draggedId);
                    const targetElement = taskElements.find(el => parseInt(el.dataset.id) === targetId);
                    
                    if (!draggedElement || !targetElement || draggedId === targetId) return;
                    
                    // Calculate new positions
                    const taskOrders = [];
                    let position = 0;
                    
                    for (const element of taskElements) {
                        const elementId = parseInt(element.dataset.id);
                        
                        if (elementId === draggedId) {
                            // Skip the dragged element in its original position
                            continue;
                        }
                        
                        if (elementId === targetId) {
                            if (placement === 'before') {
                                // Insert dragged task before target
                                taskOrders.push({ id: draggedId, position: position++ });
                                taskOrders.push({ id: targetId, position: position++ });
                            } else {
                                // Insert dragged task after target
                                taskOrders.push({ id: targetId, position: position++ });
                                taskOrders.push({ id: draggedId, position: position++ });
                            }
                        } else {
                            taskOrders.push({ id: elementId, position: position++ });
                        }
                    }
                    
                    // Send reorder request to API
                    await ApiClient.reorderTasks(taskOrders);
                    
                    // Re-render tasks to show new order
                    await renderTasks();
                    
                } catch (error) {
                    console.error('Failed to reorder tasks:', error);
                    console.error('Error details:', error.message, error.stack);
                    
                    // Check if it's an authentication error
                    if (error.message.includes('401') || error.message.includes('Authentication required') || error.message.includes('Invalid token')) {
                        alert('Authentication required. Please log in to reorder tasks.');
                        return;
                    }
                    
                    // Check if it's an HTML error page (Internal Server Error)
                    if (error.message.includes('<!DOCTYPE html>') || error.message.includes('<html')) {
                        alert('Server error occurred. Please try again. If the problem persists, check if you are logged in.');
                        return;
                    }
                    
                    if (error.needsMigration) {
                        positionColumnExists = false; // Disable drag and drop
                        alert(`Database Update Required\n\nThe drag-and-drop feature requires a database update. Please run the following SQL in your Supabase dashboard:\n\n${error.message}\n\nCheck the migrate-add-position.sql file for the complete migration script.`);
                        // Re-render to hide drag handles
                        await renderTasks();
                    } else {
                        alert(`Failed to reorder tasks: ${error.message}. Please try again.`);
                    }
                }
            };
            
            const renderTasks = async () => {
                const tasksForSelectedDay = await fetchTasks(selectedDate, showingArchive);
                // Always update allTasks with the latest fetched tasks for the selected day
                allTasks = tasksForSelectedDay;
                
                // Filter tasks based on archive view
                let filteredTasks = showingArchive 
                    ? tasksForSelectedDay.filter(task => task.archived)
                    : tasksForSelectedDay.filter(task => !task.archived);
                
                // Apply tag filter if active
                const tasksToRender = currentFilter 
                    ? filteredTasks.filter(task => task.tags.includes(currentFilter))
                    : filteredTasks;

                const emptyState = document.getElementById('empty-state');
                taskList.innerHTML = '';
                if(emptyState) taskList.appendChild(emptyState);
                
                if (tasksToRender.length === 0) {
                    if (currentFilter) {
                        emptyState.innerHTML = `<i class="fas fa-search text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">No tasks found for tag "${currentFilter}".</p>`;
                    } else {
                        emptyState.innerHTML = `<i class="fas fa-tasks text-4xl text-gray-600 mb-3"></i><p class="text-gray-400">No tasks for this day.</p>`;
                    }
                    emptyState.style.display = 'block';
                } else {
                    if(emptyState) emptyState.style.display = 'none';
                    // Tasks are already sorted by position from the backend
                    tasksToRender.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.dataset.id = task.id;
                        taskElement.dataset.position = task.position || 0;
                        taskElement.draggable = !showingArchive; // Only allow dragging in active view
                        const priorityClasses = { low: 'border-l-blue-400', medium: 'border-l-yellow-400', high: 'border-l-red-400' };
                        // Always coerce completed to boolean for robust UI
                        const isCompleted = !!task.completed;
                        taskElement.className = `task-item bg-black/10 p-4 rounded-lg shadow-md border-l-4 transition-all duration-300 border border-white/10 ${isCompleted ? 'border-green-400' : priorityClasses[task.priority]}`;
                        if (isCompleted) taskElement.classList.add('completed');
                        
                        const formattedTime = task.time ? new Date(`1970-01-01T${task.time}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                        const tagsHTML = (task.tags || []).map(tag => `<span class="tag-btn cursor-pointer text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full bg-black/20 hover:bg-indigo-500 transition text-gray-300 border border-white/10">${tag}</span>`).join('');

                        taskElement.innerHTML = `
                            <div class="flex items-start justify-between">
                                ${!showingArchive && positionColumnExists ? `<div class="drag-handle cursor-grab active:cursor-grabbing text-gray-500 hover:text-gray-300 mr-3 mt-1 flex-shrink-0" title="Drag to reorder">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>` : ''}
                                <div class="flex items-start gap-4 flex-grow">
                                    <input type="checkbox" class="custom-checkbox h-5 w-5 rounded border-white/20 mt-1 cursor-pointer appearance-none border-2 shrink-0" ${isCompleted ? 'checked' : ''}>
                                    <div class="flex-grow">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">${task.emoji}</span>
                                            <span class="task-text font-medium text-gray-200">${task.text}</span>
                                        </div>
                                        <div class="mt-2 flex items-center flex-wrap gap-y-2">
                                            ${task.time ? `<div class="text-sm text-gray-400 mr-4"><i class="far fa-clock mr-1"></i>${formattedTime}</div>` : ''}
                                            <div class="flex flex-wrap">${tagsHTML}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 shrink-0 ml-2">
                                    <button class="edit-btn text-gray-400 hover:text-indigo-400 transition"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-btn text-gray-400 hover:text-red-400 transition"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        taskElement.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleComplete(task.id, e));
                        taskElement.querySelector('.delete-btn').addEventListener('click', () => removeTask(task.id));
                        taskElement.querySelector('.edit-btn').addEventListener('click', () => openEditModal(task.id));
                        taskElement.querySelectorAll('.tag-btn').forEach(tagBtn => {
                            tagBtn.addEventListener('click', () => filterByTag(tagBtn.textContent));
                        });
                        
                        // Add drag and drop event listeners if not in archive view and position column exists
                        if (!showingArchive && positionColumnExists) {
                            setupDragAndDrop(taskElement);
                        }
                        
                        taskList.appendChild(taskElement);
                    });
                }
                updateUICounters(filteredTasks);
                await updateArchiveUI();
            };

            const updateUICounters = (currentTasks) => {
                taskCounter.textContent = `${currentTasks.length} task${currentTasks.length !== 1 ? 's' : ''}`;
                const completedTasks = currentTasks.filter(t => t.completed).length;
                const progressPercentage = currentTasks.length > 0 ? (completedTasks / currentTasks.length) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `${Math.round(progressPercentage)}%`;
                const hasUnscheduledTasks = currentTasks.some(t => !t.time);
                smartPlanBtn.classList.toggle('hidden', !hasUnscheduledTasks || currentTasks.length === 0);
                
                // Check for celebration when all tasks are completed (but NOT in archive view)
                if (!showingArchive && currentTasks.length > 0 && completedTasks === currentTasks.length && progressPercentage === 100) {
                    // Add a small delay to let the final task animation complete
                    setTimeout(() => {
                        triggerCelebration(completedTasks);
                    }, 500);
                }
            };

            const addTask = async (task) => {
                try {
                    await saveTask(task);
                    await renderTasks();
                } catch (error) {
                    alert('Failed to add task. Please try again.');
                }
            };

            const toggleComplete = async (id, event) => {
                try {
                    const task = allTasks.find(t => t.id === id);
                    if (!task) {
                        console.error('Task not found:', id);
                        return;
                    }
                    
                    const wasCompleted = task.completed;
                    const newCompletedState = !wasCompleted;
                    
                    // Play effects when completing a task (not when uncompleting)
                    if (newCompletedState) {
                        // Initialize audio context on first interaction
                        await initAudio();
                        
                        // Trigger confetti animation
                        try {
                            const rect = event.target.getBoundingClientRect();
                            const origin = { 
                                x: (rect.left + rect.right) / 2 / window.innerWidth, 
                                y: (rect.top + rect.bottom) / 2 / window.innerHeight 
                            };
                            
                            if (typeof confetti === 'function') {
                                confetti({ 
                                    particleCount: 100, 
                                    spread: 70, 
                                    origin: origin, 
                                    colors: ['#818cf8', '#c084fc', '#f472b6', '#4ade80'] 
                                });
                            } else {
                                console.warn('Confetti function not available');
                            }
                        } catch (confettiError) {
                            console.warn('Confetti animation failed:', confettiError);
                        }
                        
                        // Play completion sound
                        try {
                            if (synth && audioContextStarted) {
                                synth.triggerAttackRelease("C5", "8n");
                            }
                        } catch (audioError) {
                            console.warn('Audio playback failed:', audioError);
                        }
                    }
                    
                    // Update task completion state
                    const updatedTask = { ...task, completed: newCompletedState };
                    await updateTask(id, updatedTask);
                    
                    // Update local state immediately for better UX
                    const taskIndex = allTasks.findIndex(t => t.id === id);
                    if (taskIndex !== -1) {
                        allTasks[taskIndex] = updatedTask;
                    }
                    
                    await renderTasks();
                } catch (error) {
                    console.error('Task completion toggle failed:', error);
                    alert('Failed to update task. Please try again.');
                    // Revert checkbox state on failure
                    event.target.checked = !event.target.checked;
                }
            };
            
            const removeTask = async (id) => {
                try {
                    await deleteTask(id);
                    await renderTasks();
                } catch (error) {
                    alert('Failed to delete task. Please try again.');
                }
            };

            const openModal = (modalEl) => {
                modalEl.classList.remove('invisible', 'opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            }

            const closeModal = (modalEl) => {
                modalEl.classList.add('invisible', 'opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
            }

            const openEditModal = (id) => {
                const task = allTasks.find(t => t.id === id);
                if (!task) return;
                editTaskId.value = task.id;
                editTaskText.value = task.text;
                editTaskTime.value = task.time;
                editTaskPriority.value = task.priority;
                editTaskTags.value = task.tags.join(', ');
                openModal(editModal);
            };

            const filterByTag = (tag) => {
                currentFilter = tag;
                filterContainer.classList.remove('hidden');
                activeFilterTag.textContent = `#${tag}`;
                renderTasks();
            };

            // --- Event Listeners ---
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskText = taskInput.value.trim();
                if (taskText === '') return;

                // Initialize audio on first user interaction
                await initAudio();

                addTaskBtn.disabled = true;
                addSpinner.classList.remove('hidden');
                addBtnText.classList.add('hidden');
                
                const emojiPrompt = `Based on the task "${taskText}", suggest one single, relevant emoji. Only return the emoji itself.`;
                const emoji = await callGemini(emojiPrompt) || 'ðŸ“';
                
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const currentTime = `${hours}:${minutes}`;

                const task = {
                    id: Date.now(),
                    date: selectedDate, // Assign to the selected date
                    text: taskText,
                    emoji: emoji.trim(),
                    time: timeInput.value || currentTime,
                    priority: priorityInput.value,
                    tags: tagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean),
                    completed: false
                };
                addTask(task);
                
                taskForm.reset();
                priorityInput.value = 'low';
                addTaskBtn.disabled = false;
                addSpinner.classList.add('hidden');
                addBtnText.classList.remove('hidden');
            });

            prevWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                renderWeek();
                renderTasks();
            });

            nextWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                renderWeek();
                renderTasks();
            });
            
            suggestTasksBtn.addEventListener('click', () => openModal(suggestModal));
            cancelSuggestBtn.addEventListener('click', () => closeModal(suggestModal));
            
             generateTasksBtn.addEventListener('click', async () => {
                const goal = goalInput.value.trim();
                if (!goal) return;

                generateBtnText.classList.add('hidden');
                generateSpinner.classList.remove('hidden');
                generateTasksBtn.disabled = true;
                
                const prompt = `Based on the goal "${goal}", suggest a list of 3 to 5 actionable tasks. Return a JSON array of strings. Example: ["Task 1", "Task 2"]`;
                const responseText = await callGemini(prompt);

                if (responseText) {
                    try {
                        const suggestedTaskTexts = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, ''));
                        
                        const taskPromises = suggestedTaskTexts.map(async (taskText) => {
                            const emojiPrompt = `Based on the task "${taskText}", suggest one single, relevant emoji. Only return the emoji itself.`;
                            const emoji = await callGemini(emojiPrompt) || 'ðŸ’¡';
                            return {
                                id: Date.now() + Math.random(),
                                date: selectedDate,
                                text: taskText,
                                emoji: emoji.trim(),
                                time: '',
                                priority: 'medium',
                                tags: ['suggested', goal.split(' ')[0].toLowerCase()],
                                completed: false
                            };
                        });

                        const newTasks = await Promise.all(taskPromises);
                        newTasks.forEach(task => addTask(task));
                        
                        closeModal(suggestModal);
                        goalInput.value = '';
                    } catch (e) {
                        alert("The AI returned an unexpected format. Please try a different goal.");
                    }
                }
                
                generateBtnText.classList.remove('hidden');
                generateSpinner.classList.add('hidden');
                generateTasksBtn.disabled = false;
            });
            
            smartPlanBtn.addEventListener('click', async () => {
                const tasksForDay = allTasks.filter(t => t.date === selectedDate && !t.time);
                if (tasksForDay.length === 0) return;
                
                smartPlanBtn.innerHTML = `<div class="spinner h-5 w-5 rounded-full border-2 border-t-transparent"></div><span>Planning...</span>`;
                smartPlanBtn.disabled = true;

                const taskDescriptions = tasksForDay.map(t => `text: ${t.text}, priority: ${t.priority}`).join('; ');
                const prompt = `Here is a list of tasks for today with priorities: ${taskDescriptions}. Suggest a logical schedule starting from the current time. Assign a time (HH:mm format) for each task, considering the priority. Return a JSON object where keys are task descriptions and values are suggested times. Example: {"Task 1": "14:30", "Task 2": "16:00"}`;
                
                const responseText = await callGemini(prompt);

                if (responseText) {
                    try {
                        const schedule = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, ''));
                        allTasks = allTasks.map(task => {
                            if (task.date === selectedDate && schedule[task.text]) {
                                return { ...task, time: schedule[task.text] };
                            }
                            return task;
                        });
                        await renderTasks();
                    } catch (e) {
                         alert("The AI returned an unexpected schedule format. Please try again.");
                    }
                }

                smartPlanBtn.innerHTML = `<i class="fas fa-brain"></i> <span>âœ¨ Smart Plan</span>`;
                smartPlanBtn.disabled = false;
            });

            editTaskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = parseInt(editTaskId.value);
                const task = allTasks.find(t => t.id === id);
                if (!task) return;

                try {
                    await updateTask(id, {
                        ...task,
                        text: editTaskText.value,
                        time: editTaskTime.value,
                        priority: editTaskPriority.value,
                        tags: editTaskTags.value.split(',').map(tag => tag.trim()).filter(tag => tag)
                    });
                    await renderTasks();
                    closeModal(editModal);
                } catch (error) {
                    alert('Failed to update task. Please try again.');
                }
            });

            cancelEditBtn.addEventListener('click', () => closeModal(editModal));
            
            clearAllBtn.addEventListener('click', () => openModal(confirmClearModal));
            cancelClearBtn.addEventListener('click', () => closeModal(confirmClearModal));
            confirmClearBtn.addEventListener('click', async () => {
                try {
                    await clearAllTasks();
                    await renderTasks();
                    closeModal(confirmClearModal);
                } catch (error) {
                    alert('Failed to clear tasks. Please try again.');
                }
            });

            clearFilterBtn.addEventListener('click', () => {
                currentFilter = null;
                filterContainer.classList.add('hidden');
                renderTasks();
            });

            // Celebration modal event listeners
            closeCelebrationBtn.addEventListener('click', async () => {
                try {
                    // Archive completed tasks when closing celebration
                    await archiveCompletedTasks(selectedDate);
                    closeModal(celebrationModal);
                    await renderTasks(); // Refresh to show archived tasks are gone
                } catch (error) {
                    console.error('Error archiving tasks:', error);
                    closeModal(celebrationModal);
                }
            });

            addTomorrowTasksBtn.addEventListener('click', async () => {
                try {
                    // Archive completed tasks from today before moving to tomorrow
                    const todayDate = selectedDate;
                    await archiveCompletedTasks(todayDate);
                    
                    closeModal(celebrationModal);
                    
                    // Navigate to tomorrow - properly parse the ISO date string
                    const currentSelectedDate = new Date(selectedDate + 'T00:00:00');
                    const tomorrow = new Date(currentSelectedDate);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    // Update the selected date
                    selectedDate = toISODateString(tomorrow);
                    
                    // Update the current date for week navigation
                    currentDate = new Date(tomorrow);
                    
                    // Re-render everything for the new date
                    renderWeek();
                    renderTasks();
                    updateSelectedDateDisplay();
                    
                    // Focus on the task input for easy task creation
                    setTimeout(() => {
                        taskInput.focus();
                    }, 300);
                    
                    console.log('Archived tasks from', todayDate, 'and navigated to tomorrow:', selectedDate);
                } catch (error) {
                    console.error('Error during tomorrow navigation:', error);
                    closeModal(celebrationModal);
                }
            });

            // Archive toggle functionality
            archiveToggleBtn.addEventListener('click', () => {
                showingArchive = !showingArchive;
                renderTasks();
            });

            // --- Setup Task List Drop Zone ---
            const setupTaskListDropZone = () => {
                taskList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                taskList.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    
                    if (draggedElement) {
                        // If dropped on empty area, move to end
                        const allTasks = Array.from(taskList.querySelectorAll('.task-item'));
                        if (allTasks.length > 0) {
                            const lastTask = allTasks[allTasks.length - 1];
                            const lastTaskId = parseInt(lastTask.dataset.id);
                            if (lastTaskId !== draggedTaskId) {
                                await handleTaskReorder(draggedTaskId, lastTaskId, 'after');
                            }
                        }
                    }
                });
            };
            
            // --- Initial Load ---
            setupTaskListDropZone();
            renderWeek();
            renderTasks();
        });
    </script>
</body>
</html>
