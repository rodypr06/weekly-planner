<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
        .log { background: #222; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .error { background: #441; color: #faa; }
        .success { background: #141; color: #afa; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Authentication Debug Tool</h1>
    
    <div>
        <button onclick="testConfigLoad()">1. Test Config Load</button>
        <button onclick="testSupabaseInit()">2. Test Supabase Init</button>
        <button onclick="testAuthCheck()">3. Test Auth Check</button>
        <button onclick="testLogin()">4. Test Login</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <!-- Load required scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/public/supabase-auth.js"></script>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
            
            // Also log to console
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testConfigLoad() {
            log('Testing configuration load...', 'info');
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const config = await response.json();
                log(`✓ Config loaded successfully: ${JSON.stringify(config)}`, 'success');
                return config;
            } catch (error) {
                log(`✗ Config load failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testSupabaseInit() {
            log('Testing Supabase initialization...', 'info');
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase CDN not loaded');
                }
                log('✓ Supabase CDN loaded', 'success');

                const initialized = await initializeSupabase();
                if (initialized) {
                    log('✓ Supabase client initialized successfully', 'success');
                } else {
                    log('✗ Supabase initialization failed', 'error');
                }
                return initialized;
            } catch (error) {
                log(`✗ Supabase initialization error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAuthCheck() {
            log('Testing authentication check...', 'info');
            try {
                const authStatus = await SupabaseAuth.checkAuth();
                log(`Auth status: ${JSON.stringify(authStatus)}`, authStatus.authenticated ? 'success' : 'info');
                return authStatus;
            } catch (error) {
                log(`✗ Auth check failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testLogin() {
            const email = prompt('Enter email for test:');
            const password = prompt('Enter password for test:');
            
            if (!email || !password) {
                log('Login test cancelled', 'info');
                return;
            }

            log(`Testing login with email: ${email}`, 'info');
            try {
                const result = await SupabaseAuth.login(email, password);
                if (result.success) {
                    log(`✓ Login successful: ${JSON.stringify(result.user)}`, 'success');
                } else {
                    log(`✗ Login failed: ${result.error}`, 'error');
                }
                return result;
            } catch (error) {
                log(`✗ Login error: ${error.message}`, 'error');
                return null;
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', async () => {
            log('=== Auto-running basic tests ===', 'info');
            await testConfigLoad();
            await testSupabaseInit();
            await testAuthCheck();
        });
    </script>
</body>
</html>